#!/bin/bash

# Проверка количества аргументов
if [[ $# -ne 3 ]]; then
    echo "Использование: chsuf <каталог> <старый_суффикс> <новый_суффикс>" >&2
    exit 1
fi

DIR="$1"
OLD="$2"
NEW="$3"

# -----------------------------
# Проверка каталога
# -----------------------------
if [[ ! -d "$DIR" ]]; then
    echo "Ошибка: '$DIR' не является каталогом" >&2
    exit 1
fi

# -----------------------------
# Проверка корректности суффиксов
# суффикс:
#   начинается с '.'
#   НЕ содержит других '.'
# -----------------------------
check_suffix() {
    local suf="$1"

    # должен начинаться с .
    if [[ "${suf:0:1}" != "." ]]; then
        return 1
    fi

    # после первой точки — не должно быть больше точек
    local rest="${suf:1}"
    if [[ "$rest" == *.* ]]; then
        return 1
    fi

    return 0
}

if ! check_suffix "$OLD"; then
    echo "Ошибка: старый суффикс '$OLD' некорректный" >&2
    exit 1
fi

if ! check_suffix "$NEW"; then
    echo "Ошибка: новый суффикс '$NEW' некорректный" >&2
    exit 1
fi

# -----------------------------
# Обработка файлов
# -----------------------------

# Используем find -type f, как требует задание (только регулярные файлы)
# Рекурсивный поиск
while IFS= read -r -d '' file; do
    filename="$(basename "$file")"

    # Проверяем, что файл действительно оканчивается на OLD
    if [[ "$filename" == *"$OLD" ]]; then
        # Генерация нового имени через раскрытие параметров
        newfile="${file/%$OLD/$NEW}"

        # Переименовываем
        mv "$file" "$newfile"
    fi
done < <(find "$DIR" -type f -print0)
